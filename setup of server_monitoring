---
- name: Download and Install Prometheus Node Exporter
  hosts: all
  become: yes

  tasks:
    - name: Load data from prometheus.yml
      ansible.builtin.include_vars:
        file: /etc/prometheus/prometheus.yml
      register: prometheus_config

    - debug:
        var: prometheus_config

    - name: Get latest Node Exporter URL
      ansible.builtin.shell:
        cmd: curl -s https://api.github.com/repos/prometheus/node_exporter/releases/latest | grep "browser_download_url.*linux-amd64" | cut -d '"' -f 4
      register: node_exporter_url

    - name: Download Prometheus Node Exporter
      ansible.builtin.get_url:
        url: "{{ node_exporter_url.stdout }}"
        dest: /tmp/node_exporter.tar.gz

    - name: Extract Node Exporter archive
      ansible.builtin.unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /usr/local/bin
        creates: /usr/local/bin/node_exporter-1.2.3.linux-amd64/node_exporter
      register: extract_result
      changed_when: extract_result.changed

    - name: Remove temporary files
      ansible.builtin.file:
        path: /tmp/node_exporter.tar.gz
        state: absent

    - name: Create systemd service for Node Exporter
      ansible.builtin.template:
        src: /etc/ansible/playbooks/templates/node_exporter.service.j2
        dest: /etc/systemd/system/node_exporter.service
      notify:
        - Restart Node Exporter

    - name: Allow incoming traffic on Prometheus ports using ufw
      ansible.builtin.command:
        cmd: "ufw allow 9100"
      become: yes

  handlers:
    - name: Restart Node Exporter
      ansible.builtin.systemd:
        name: node_exporter
        state: restarted

